#!/bin/bash
set -eu

VERBOSITY=${GETH_VERBOSITY:-3}
OP_GETH_DATA=/datadir
OP_GETH_CHAINDATA_DIR="$OP_GETH_DATA/geth/chaindata"
OP_GETH_GENESIS_FILE_PATH="${OP_GETH_GENESIS_FILE_PATH:-/genesis.json}"
CHAIN_ID=$(jq -r .config.chainId < "$OP_GETH_GENESIS_FILE_PATH")
OP_GETH_RPC_PORT="${OP_GETH_RPC_PORT:-8545}"
OP_GETH_WS_PORT="${OP_GETH_WS_PORT:-8546}"
OP_GETH_AUTHRPC_PORT="${OP_GETH_AUTHRPC_PORT:-8551}"
OP_GETH_METRICS_PORT="${OP_GETH_METRICS_PORT:-6060}"
HOST_IP="0.0.0.0"
ADDITIONAL_ARGS=""

mkdir -p $OP_GETH_DATA

if [ ! -d "$OP_GETH_CHAINDATA_DIR" ]; then
	echo "$OP_GETH_CHAINDATA_DIR missing, running init"
	echo "Initializing genesis."
	./geth --verbosity="$VERBOSITY" init \
		--datadir="$OP_GETH_DATA" \
		"$OP_GETH_GENESIS_FILE_PATH"
else
	echo "$OP_GETH_CHAINDATA_DIR exists."
fi

echo "$OP_NODE_L2_ENGINE_AUTH_RAW" > "$OP_NODE_L2_ENGINE_AUTH"

if [ "${OP_GETH_ETH_STATS+x}" = x ]; then
  ADDITIONAL_ARGS="$ADDITIONAL_ARGS --ethstats=$OP_GETH_ETH_STATS"
fi

if [ "${OP_GETH_ALLOW_UNPROTECTED_TXS+x}" = x ]; then
	ADDITIONAL_ARGS="$ADDITIONAL_ARGS --rpc.allow-unprotected-txs=$OP_GETH_ALLOW_UNPROTECTED_TXS"
fi

exec ./geth \
	--datadir="$OP_GETH_DATA" \
	--verbosity="$VERBOSITY" \
	--http \
	--http.corsdomain="*" \
	--http.vhosts="*" \
	--http.addr=0.0.0.0 \
	--http.port="$OP_GETH_RPC_PORT" \
	--http.api=web3,debug,eth,txpool,net,engine \
    --ws \
	--ws.addr=0.0.0.0 \
	--ws.port="$OP_GETH_WS_PORT" \
	--ws.origins="*" \
	--ws.api=debug,eth,txpool,net,engine \
    --syncmode=full \
	--gcmode=archive \
	--nodiscover \
	--maxpeers=0 \
	--networkid="$CHAIN_ID" \
    --authrpc.vhosts="*" \
	--authrpc.addr=0.0.0.0 \
	--authrpc.port="$OP_GETH_AUTHRPC_PORT" \
	--authrpc.jwtsecret="$OP_NODE_L2_ENGINE_AUTH" \
	--metrics \
	--metrics.addr=0.0.0.0 \
	--metrics.port="$OP_GETH_METRICS_PORT" \
	--rollup.disabletxpoolgossip=true \
	$ADDITIONAL_ARGS # intentionally unquoted